<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Meals - HealthyLife</title>
  <link rel="stylesheet" type="text/css" href="css/meals.css" />
  <link rel="stylesheet" type="text/css" href="css/header.css" />
  <link rel="stylesheet" type="text/css" href="css/footer.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="/js/mealsTable.js" defer></script>

</head>
<body>
  <div id="page">
    <%- include('../partial/header') %>
    <%- include('../partial/massages') %>

    <div id="content">
      <!-- סינון לפי טווח תאריכים -->
      <div class="filter-section">
        <form id="filter" action="/meals/filterMeals" method="POST">
            <div class="form-group">
                <label for="startDate">Start Date:</label>
                <input type="date" id="startDate" name="startDate">
            </div>
            <div class="form-group">
                <label for="endDate">End Date:</label>
                <input type="date" id="endDate" name="endDate">
            </div>
            <button type="button" id="filterButton">Filter</button>
        </form>
      </div>

      <!-- גרף רמות סוכר -->
      <div class="chart-container">
        <h2>Blood Glucose Level Over Time</h2>
        <canvas id="glucoseChart"></canvas>
      </div>

      <!-- הודעה אם אין משתמש מחובר -->
      <div id="noHistoryMessage" class="no-history-message" style="display:none;">
        No meals history, need to connect.
      </div>

      <!-- טבלה להארוחות -->
      <table id="mealTable" style="<%= meals.length > 0 ? 'display: table;' : 'display: none;' %>">
        <thead>
          <tr>
            <th style="display: none;">Username</th>
            <th>Meal Type</th>
            <th>Date</th>
            <th>Description</th>
            <th>Blood glucose level</th>
            <th>Holiday</th>
          </tr>
        </thead>
        <tbody>
          <% if (meals && meals.length > 0) { %>
            <% meals.forEach(function(meal) { %>
              <tr>
                <td style="display: none;"><%= meal.username %></td>
                <td><%= meal.mealType %></td>
                <td><%= new Date(meal.date).toLocaleDateString() %></td>
                <td><%= meal.description || 'No description' %></td>
                <td><%= meal.glucoseLevel %></td>
                <td><%= meal.holiday %></td>
              </tr>
            <% }); %>
          <% } else { %>
            <tr>
              <td colspan="6" style="text-align:center;">No meals available.</td>
            </tr>
          <% } %>
        </tbody>
      </table>
    </div>

    <%- include('../partial/footer') %> 
  </div>

  <script>
    const mealRows = document.querySelectorAll('#mealTable tbody tr');
    let allMeals = [];
    let chartInstance = null;

    // איסוף כל המידע מהטבלה
    mealRows.forEach(row => {
        const date = row.cells[2]?.innerText.trim();
        const glucoseLevel = row.cells[4]?.innerText.trim();
        const mealType = row.cells[1]?.innerText.trim();
        const description = row.cells[3]?.innerText.trim();
        const holiday = row.cells[5]?.innerText.trim();

        if (date && glucoseLevel) {
            allMeals.push({
                date: new Date(date).toLocaleDateString(),
                glucoseLevel: parseInt(glucoseLevel),
                mealType,
                description,
                holiday
            });
        }
    });

    // יצירת גרף
    function createGlucoseChart(filteredMeals) {
        const ctx = document.getElementById('glucoseChart').getContext('2d');
        if (chartInstance) {
            chartInstance.destroy();
        }

        const dates = filteredMeals.map(meal => meal.date);
        const glucoseLevels = filteredMeals.map(meal => meal.glucoseLevel);

        chartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: dates,
                datasets: [{
                    label: 'Blood Glucose Level',
                    data: glucoseLevels,
                    borderColor: 'rgba(75, 192, 192, 1)',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                }]
            }
        });
    }

    createGlucoseChart(allMeals);

    document.getElementById('filterButton').addEventListener('click', () => {
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;

        const filteredMeals = allMeals.filter(meal => {
            const mealDate = new Date(meal.date);
            const start = startDate ? new Date(startDate) : null;
            const end = endDate ? new Date(endDate) : null;

            return (!start || mealDate >= start) && (!end || mealDate <= end);
        });

        createGlucoseChart(filteredMeals);
    });
  </script>
</body>
</html>
